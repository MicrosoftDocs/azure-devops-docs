---
title: Troubleshooting build
description: Troubleshooting Team Foundation Build (TFBuild) in Team Foundation Server and VSTS.
ms.prod: vs-devops-alm
ms.technology: vs-devops-build
ms.assetid: BFCB144F-9E9B-4FCB-9CD1-260D6873BC2E
ms.manager: douge
ms.author: alewis
ms.date: 08/04/2016
---

# Troubleshooting build

[!INCLUDE [temp](../_shared/version.md)]

## Run commands locally at the command prompt
It is helpful to narrow whether a build failure is the result of a TFS/VSTS product issue (agent or tasks). Build failures may also result from external commands.

Check the build log for the exact command-line executed by the failing step. Attempting to run the command locally from the command line, may reproduce the issue. It can be helpful to run the command locally from your own machine, and/or log-in to the build machine and run the command as the service account.

For example, is the problem happening during the MSBuild part of your build process (for example, are you using either the [MSBuild](../tasks/build/msbuild.md) or [Visual Studio Build](../tasks/build/visual-studio-build.md) step)? If so, then try running the same [MSBuild command](https://msdn.microsoft.com/en-us/library/ms164311.aspx) on a local machine using the same arguments.  If you can reproduce the problem on a local machine, then your next steps are to investigate the [MSBuild](https://msdn.microsoft.com/en-us/library/dd393574.aspx) problem.

### Differences between local command prompt and agent
Keep in mind, some differences are in effect when executing a command on a local machine and when a build is running on an agent. If the agent is configured to run as a service on Linux, macOS, or Windows, then it is not running within an interactive logged-on session. Without an interactive logged-on session, UI interaction and other limitations exist.


## Get logs to diagnose problems


### Build logs

Start by looking at the logs in your completed build. If they don't provide enough detail, you can make them more verbose:

0. On the **Variables** tab, add ```system.debug``` and set it to ```true```. Select to allow at queue time.

0. Queue the build.

0. In the explorer tab, view your completed build and click the build step to view its output.

0. If you need a copy of all the logs, click **Download all logs as zip**.


### Diagnostic logs

0. Log on to the agent machine.

0. Go to the `_diag` subfolder in the directory where the build agent is installed. For example: `c:\agent\_diag`

#### Worker diagnostic logs

You can get the diagnostic log of the completed build that was generated by the worker process on the build agent. Look for the `worker` log file that has the date and time stamp of your completed build. For example, `worker_20160623-192022-utc_6172.log`.

#### Agent diagnostic logs

Agent diagnostic logs provide a record of how the agent was configured and what happened when it ran. Look for the `agent` log files. For example, `agent_20160624-144630-utc.log`. There are two kinds of agent log files:

* The log file generated when you ran `config.cmd`. This log:

 - Includes this line near the top: `Adding Command: configure`

 - Shows the configuration choices made.

* The log file generated when you ran `run.cmd`. This log:

 - Cannot be opened until the process is terminated.

 - Attempts to connect to your Team Foundation Server or VSTS account.

 - Shows when each job was run, and how it completed

Both logs show how the agent capabilities were detected and set.

### HTTP trace logs

> **Important:** HTTP traces and trace files can contain passwords and other secrets. Do **not** post them on a public sites.

#### Use built-in HTTP tracing

If your agent is version 2.114.0 or newer, you can trace the HTTP traffic headers and write them into the diagnostic log. Set the `VSTS_AGENT_HTTPTRACE` environment variable before you launch the agent.listener.

```bash
Windows:
    set VSTS_AGENT_HTTPTRACE=true

macOS/Linux:
    export VSTS_AGENT_HTTPTRACE=true
```

#### Use full HTTP tracing

##### Windows

0. Start [Fiddler](http://www.telerik.com/fiddler). 

0. We recommend you listen only to agent traffic.  File > Capture Traffic off (F12)  

0. Enable decrypting HTTPS traffic.  Tools > Fiddler Options > HTTPS tab. Decrypt HTTPS traffic

0. Let the agent know to use the proxy:

 ```cmd
set VSTS_HTTP_PROXY=http://127.0.0.1:8888
 ```

0. Run the agent interactively.  If you're running as a service, you can set as the environment variable in control panel for the account the service is running as.

0. Restart the agent.


##### macOS and Linux

Use Charles Proxy (similar to Fiddler on Windows) to capture the HTTP trace of the agent.

0. Start Charles Proxy.

0. Charles: Proxy > Proxy Settings > SSL Tab.  Enable.  Add URL.  

0. Charles: Proxy > Mac OSX Proxy.  Recommend disabling to only see agent traffic.

 ```bash
export VSTS_HTTP_PROXY=http://127.0.0.1:8888
 ```

0. Run the agent interactively.  If it's running as a service, you can set in the .env file.  See [nix service](https://github.com/Microsoft/vsts-agent/blob/master/docs/start/nixsvc.md)

0. Restart the agent.

## File- and folder-in-use errors
File or folder in use errors are often indicated by error messages such as:
> Access to the path [...] is denied.  
> The process cannot access the file [...] because it is being used by another process.  
> Access is denied.  
> Can't move [...] to [...]

### Detect files and folders in use
On Windows, tools like [Process Monitor](https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx) can be to capture a trace of file events under a specific directory. Or, for a snapshot in time, tools like [Process Explorer](https://technet.microsoft.com/en-us/sysinternals/processexplorer.aspx) or [Handle](https://technet.microsoft.com/en-us/sysinternals/handle.aspx) can be used.

### Anti-virus exclusion
Anti-virus software scanning your files can cause file or folder in use errors during a build. Adding an anti-virus exclusion for your agent directory and configured "work folder" may help to identify anti-virus software as the interfering process.

### MSBuild and /nodeReuse:false
If you invoke MSBuild during your build, make sure to pass the argument `/nodeReuse:false` (short form `/nr:false`). Otherwise MSBuild process(es) will remain running after the build completes. The process(es) remain for some time in anticipation of a potential subsequent build.

This feature of MSBuild can interfere with attempts to delete or move a directory - due to a conflict with the working directory of the MSBuild process(es).

The MSBuild and Visual Studio Build tasks already add `/nr:false` to the arguments passed to MSBuild. However, if you invoke MSBuild from your own script, then you would need to specify the argument.

<!-- This header is linked internally from this document. Any changes to the header text must be made to the link as well. -->
### MSBuild and /maxcpucount:[n]

By default the build steps such as [MSBuild](../tasks/build/msbuild.md) and [Visual Studio Build](../tasks/build/visual-studio-build.md) run MSBuild with the `/m` switch. In some cases this can cause problems such as multiple process file access issues. 

Try adding the `/m:1` argument to your build steps to force MSBuild to run only one process at a time.

File-in-use issues may result when leveraging the concurrent-process feature of MSBuild. Not specifying the argument `/maxcpucount:[n]` (short form `/m:[n]`) instructs MSBuild to use a single process only. If you are using the MSBuild or Visual Studio Build tasks, you may need to specify "/m:1" to override the "/m" argument that is added by default.

## Intermittent or inconsistent MSBuild failures

If you are experiencing intermittent or inconsistent MSBuild failures, try instructing MSBuild to use a single-process only. Intermittent or inconsistent errors may indicate that your target configuration is incompatible with the concurrent-process feature of MSBuild. See [MSBuild and /maxcpucount:[n]](#msbuild-and-maxcpucountn)

## Process hang

### Waiting for Input
A process hang may indicate that a process is waiting for input.

Running the agent from the command line of an interactive logged on session may help to identify whether a process is prompting with a dialog for input.

Running the agent as a service may help to eliminate programs from prompting for input. For example in .Net, programs may rely on the System.Environment.UserInteractive Boolean to determine whether to prompt. When running as a Windows service, the value is false.

### Process dump
Analyzing a dump of the process can help to identify what a deadlocked process is waiting on.

### WiX project
Building a WiX project when custom MSBuild loggers are enabled, can cause WiX to deadlock waiting on the output stream. Adding the additional MSBuild argument `/p:RunWixToolsOutofProc=true` will workaround the issue.

## Agent connection issues

### Config fails while testing agent connection (on-premises TFS only)

```
Testing agent connection.
VS30063: You are not authorized to access http://<SERVER>:8080/tfs
```

If the above error is received while configuring the agent, log on to your TFS machine. Start the Internet Information Services (IIS) manager. Make sure **Anonymous Authentication** is enabled.

![iis tfs anonymous authentication enabled](_img/troubleshooting/iis-tfs-anonymous-authentication-enabled.png)

<!-- https://go.microsoft.com/fwlink/?linkid=846610 -->
<h3 id="renew-lock">Agent lost communication</h3>

This issue is characterized by the error message:
```
The agent: {AGENTNAME} lost communication with the server. Verify the machine is running and has a healthy network connection.
```

This error may indicate the agent lost communication with the server for a span of several minutes. Check the following to rule out network or other interruptions on the agent machine:

* Verify automatic updates are turned off. A machine reboot from an update will cause a build to fail with the above error. Apply updates in a controlled fashion to avoid this type of interruption. Before rebooting the agent machine, the agent should first be marked disabled in the pool administration page and let any running build finish.
* Verify the sleep settings are turned off.
* If the agent is running on a virtual machine, avoid any live migration or other VM maintenance operation that may severly impact the health of the machine for multiple minutes.
* If the agent is running on a virtual machine, the same operating-system-update recommendations and sleep-setting recommendations apply to the host machine. And also any other maintenance operations that several impact the host machine.
* Performance monitor logging or other health metric logging can help to correlate this type of error to constrained resource availability on the agent machine (disk, memory, page file, processor, network).
* Another way to correlate the error with network problems is to ping a server indefinitely and dump the output to a file, along with timestamps. Use a healthy interval, for example 20 or 30 seconds. If you are using VSTS, then you would want to ping an internet domain, for example bing.com. If you are using an on-premises TFS server, then you would want to ping a server on the same network.
* Verify the network throughput of the machine is adequate. You can perform an online speed test to check the throughput.
* If you use a proxy, verify the agent is configured to use your proxy. Refer to the agent deployment topic.

Check if agent diagnostic logs provide any further information regarding the communication issue. Refer to the [Troubleshooting steps](https://docs.microsoft.com/en-us/vsts/build-release/actions/troubleshooting) for information regarding agent diagnostic logs.

If the troubleshooting does not help, please file an [issue](https://github.com/Microsoft/vsts-agent/issues/new) on vsts-agent.

### Work with SSL server certificate (on-premises TFS only)

```
Enter server URL > https://corp.tfs.com/tfs
Enter authentication type (press enter for Integrated) >
Connecting to server ...
An error occurred while sending the request.
```

Agent diagnostic log shows:
```
[2017-11-06 20:55:33Z ERR  AgentServer] System.Net.Http.HttpRequestException: An error occurred while sending the request. ---> System.Net.Http.WinHttpException: A security error occurred
```

This error may indicate the server certificate you used on your TFS server is not trusted by the build machine. Make sure you install your self-signed ssl server certificate into the OS certificate store.
```
Windows: Windows certificate store
Linux: OpenSSL certificate store
macOS: OpenSSL certificate store for agent version 2.124.0 or below
       Keychian for agent version 2.125.0 or above
```

You can easily verify whether the certificate has been installed correctly by running few commands.
You should be good as long as SSL handshake finished correctly even you get a 401 for the request.
```
Windows: PowerShell Invoke-WebRequest -Uri https://corp.tfs.com/tfs -UseDefaultCredentials 
Linux: curl -v https://corp.tfs.com/tfs 
macOS: curl -v https://corp.tfs.com/tfs (agent version 2.124.0 or below, curl needs to be built for OpenSSL)
       curl -v https://corp.tfs.com/tfs (agent version 2.125.0 or above, curl needs to be built for Secure Transport)
```

If somehow you can't successfully install certificate into your machine's certificate store due to various reasons, like: you don't have permission or you are on a customized Linux machine.
The agent version 2.125.0 or above has the ability to ignore SSL server certificate validation error.

> [!IMPORTANT]
> 
> This is not secure and not recommended, we highly suggest you to install the certificate into your machine certificate store. 

Pass `--sslskipcertvalidation` during agent configuration
```
./config.cmd/sh --sslskipcertvalidation
```

> [!NOTE]
> 
> There is limitation of using this flag on Linux and macOS  
> The libcurl library on your Linux or macOS machine needs to built with OpenSSL, [More Detail](https://github.com/dotnet/corefx/issues/9728)

### Work with SSL client certificate (on-premises TFS only)

IIS has a SSL setting that requires all incoming requests to TFS must present client certificate in addition to the regular credential.

When that IIS SSL setting enabled, you need to use `2.125.0` or above version agent and follow these extra steps in order to configure the build machine against your TFS server.

- Prepare all required certificate informations
  - CA certificate(s) in `.pem` format (This should contains the public key and signature of the CA certificate, you need put the root ca certificate and all your intermediate ca certificates into one `.pem` file)  
  - Client certificate in `.pem` format (This should contains the public key and signature of the Client certificate)  
  - Client certificate private key in `.pem` format (This should contains only the private key of the Client certificate)  
  - Client certificate archive package in `.pfx` format (This should contains the signature, public key and private key of the Client certificate)  
  - Use `SAME` password to protect Client certificate private key and Client certificate archive package, since they both have client certificate's private key  

- Install CA certificate(s) into machine certificate store
  - Windows: Windows certificate store
  - Linux: OpenSSL certificate store
  - macOS: System or User Keychian

- Pass `--sslcacert`, `--sslclientcert`, `--sslclientcertkey`. `--sslclientcertarchive` and `--sslclientcertpassword` during agent configuration.   
 ```
 .\config.cmd/sh --sslcacert ca.pem --sslclientcert clientcert.pem --sslclientcertkey clientcert-key-pass.pem --sslclientcertarchive clientcert-archive.pfx --sslclientcertpassword "mypassword"
 ```

 We store your client cert private key password securely on each platform.  
 ```
 Windows: Windows Credential Store
 macOS: macOS Keychain
 Linux: Encrypted with a symmetric key based on the machine ID
 ```

Click [here](https://github.com/Microsoft/vsts-agent/blob/master/docs/design/clientcert.md) for more detail information about agent client certificate support.

### Builds not starting

#### TFS Job Agent not started
This may be characterized by a message in the web console "Waiting for an agent to be requested". Verify the TFSJobAgent (display name: *Visual Studio Team Foundation Background Job Agent*) Windows service is started.

#### Misconfigured notifcation URL (1.x agent version)
This may be characterized by a message in the web console "Waiting for console output from an agent", and the build eventually times out.

A mismatching notification URL may cause the worker to process to fail to connect to the server. See *Team Foundation Administration Console*, *Application Tier*. The 1.x agent listens to the message queue using the URL that it was configured with. However, when a job message is pulled from the queue, the worker process uses the notification URL to communicate back to the server.

## Git

### Get sources fails with SSL certificate problem (on-premises TFS and Windows agent only)
We ship git.exe as part of windows agent, we use this git.exe for all Git related operation. 
When you have a self-signed SSL certificate for your on-premises TFS server, make sure to configure the git.exe we shipped to allow that self-signed SSL certificate.
The most reliable way might be to set the following git config in global level by the agent's run as user.
```bash
git config --global http."https://tfs.com/".sslCAInfo certificate.pem
```
Setting system level git config is not reliable on Windows, since the system level .gitconfig file is stored at the copy of git.exe we packaged which will get replaced whenever the agent is upgraded to a new version.

## Team Foundation Version Control (TFVC)

### Get sources not downloading some files
This may be characterized by a message in the build log "All files up to date" from the *tf get* command. Verify the built-in build service identity has permission to download the sources. Either the identity *Project Collection Build Service* or *Project Build Service* will need permission to download the sources, depending on the selected authorization scope on General tab of the build definition. In the version control web UI, you can browse the project files at any level of the folder hierarchy and check the security settings.

## I need more help. I found a bug. I've got a suggestion. Where do I go?

[Get subscription, billing, and technical support](https://www.visualstudio.com/support-overview-vs)

Report any problems on [Developer Community](https://developercommunity.visualstudio.com/).

We welcome your suggestions:

* Propose and vote on ideas on [UserVoice](https://visualstudio.uservoice.com/forums/330519-team-services).
